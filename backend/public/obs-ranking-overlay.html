<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OBS Ranking Overlay</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      overflow: hidden;
      font-family: 'Segoe UI', sans-serif;
    }
    #ranking-container {
      position: fixed;
      top: 20px;
      right: 0;
      width: 300px;
      background: transparent;
      padding: 10px 0 10px 10px;
      color: white;
      text-shadow: 
        -1px -1px 0 #000,  
         1px -1px 0 #000,
        -1px  1px 0 #000,
         1px  1px 0 #000,
         0 2px 4px rgba(0,0,0,0.9);
    }
    h2 {
      margin: 0 0 12px 0;
      font-size: 18px;
      text-align: right; /* Changed from center to right */
      color: #fbbf24;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 
        -2px -2px 0 #000,  
         2px -2px 0 #000,
        -2px  2px 0 #000,
         2px  2px 0 #000;
    }
    .rank-item {
      display: flex;
      align-items: center;
      justify-content: flex-end; /* Align items to the right */
      padding: 8px 0;
      /* border-bottom: 1px solid rgba(255,255,255,0.1); Removed border to look cleaner transparent */
    }
    .rank-item:last-child {
      border-bottom: none;
    }
    .rank-num {
      width: 24px;
      font-weight: bold;
      color: #9ca3af;
      text-align: center; /* Keep rank number centered in its box */
      order: 3; /* Move rank number to the rightmost */
      margin-left: 10px; /* Add margin left */
    }
    .rank-num.top-1 { color: #fbbf24; font-size: 1.2em; }
    .rank-num.top-2 { color: #94a3b8; font-size: 1.1em; }
    .rank-num.top-3 { color: #b45309; font-size: 1.1em; }
    
    .rank-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-left: 10px; /* Changed from margin-right to margin-left */
      margin-right: 0;
      background: #333;
      object-fit: cover;
      order: 2; /* Move avatar to the middle */
    }
    .rank-info {
      flex: 1;
      overflow: hidden;
      text-align: right; /* Align text to the right */
      order: 1; /* Move info to the leftmost (visually rightmost in RTL thinking, but here we just reorder) */
    }
    .rank-name {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .rank-points {
      font-size: 0.85em;
      color: #4ade80;
    }
  </style>
</head>
<body>
  <div id="ranking-container">
    <h2>Top Donators</h2>
    <div id="ranking-list">
      <!-- Items will be injected here -->
      <div style="text-align:center; color:#666;">Loading...</div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const socket = io('http://localhost:5001', { transports: ['websocket', 'polling'] });
    const listEl = document.getElementById('ranking-list');

    function renderRanking(rankings) {
      if (!rankings || rankings.length === 0) {
        listEl.innerHTML = '<div style="text-align:center; color:#666;">No data</div>';
        return;
      }

      listEl.innerHTML = rankings.map((r, index) => {
        const rank = index + 1;
        const rankClass = rank <= 3 ? `top-${rank}` : '';
        const avatarUrl = r.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(r.name)}&background=random`;
        
        return `
          <div class="rank-item">
            <div class="rank-num ${rankClass}">${rank}</div>
            <img src="${avatarUrl}" class="rank-avatar" onerror="this.src='https://ui-avatars.com/api/?name=?'" />
            <div class="rank-info">
              <div class="rank-name">${r.name}</div>
              <div class="rank-points">${r.points.toLocaleString()} pts</div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function fetchRanking() {
      try {
        const res = await fetch('http://localhost:5001/api/rankings/top');
        if (res.ok) {
          const json = await res.json();
          // API returns { success: true, ranks: [...] }
          if (json.success && Array.isArray(json.ranks)) {
            renderRanking(json.ranks);
          } else if (Array.isArray(json)) {
            // Fallback if API changes to return array directly
            renderRanking(json);
          }
        }
      } catch (err) {
        console.error('Error fetching ranking:', err);
      }
    }

    // Initial fetch
    fetchRanking();

    // Listen for updates
    socket.on('ranking-update', (data) => {
      console.log('Ranking update received:', data);
      renderRanking(data);
    });
    
    // Also refresh periodically just in case
    setInterval(fetchRanking, 30000);
  </script>
</body>
</html>